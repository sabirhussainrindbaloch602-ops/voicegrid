<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="VoiceGrid - AI-powered meeting documentation for field workers">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://generativelanguage.googleapis.com; media-src 'self' blob:;">
    <title>VoiceGrid - Smart Meeting Documentation</title>
    <style>
        /* ===== CSS RESET AND BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Professional color palette optimized for outdoor visibility and indoor use */
            --primary-blue: #2563eb;
            --primary-blue-dark: #1e40af;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --warning-yellow: #f59e0b;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --success: #22c55e;
            --error: #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== CONTAINER AND LAYOUT ===== */
        .container {
            max-width: 100%;
            padding: 0;
            margin: 0 auto;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== HEADER COMPONENT ===== */
        .header {
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover, .icon-btn:active {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* ===== WELCOME/AUTH SCREEN ===== */
        .welcome-content {
            text-align: center;
            padding: 40px 20px;
        }

        .app-logo {
            font-size: 64px;
            margin-bottom: 24px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .welcome-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 40px 0;
            text-align: left;
        }

        .feature-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .feature-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .feature-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .feature-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ===== BUTTON STYLES ===== */
        .btn {
            display: block;
            width: 100%;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 56px;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover, .btn-primary:active {
            background: var(--primary-blue-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover, .btn-secondary:active {
            background: var(--bg-secondary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            min-height: 52px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: var(--bg-card);
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .form-error {
            color: var(--error);
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .form-error.active {
            display: block;
        }

        /* ===== RECORDING INTERFACE ===== */
        .recording-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            padding: 20px;
        }

        .record-button {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: none;
            background: var(--primary-blue);
            color: white;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
            position: relative;
        }

        .record-button:hover {
            transform: scale(1.05);
        }

        .record-button.recording {
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
            }
            50% {
                box-shadow: 0 8px 32px rgba(239, 68, 68, 0.6);
            }
        }

        .record-status {
            margin-top: 24px;
            text-align: center;
        }

        .record-status-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .record-timer {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-blue);
            font-variant-numeric: tabular-nums;
        }

        .record-timer.recording {
            color: var(--accent-red);
        }

        .audio-visualizer {
            width: 100%;
            max-width: 300px;
            height: 60px;
            margin: 24px 0;
            display: none;
        }

        .audio-visualizer.active {
            display: block;
        }

        .visualizer-bar {
            display: inline-block;
            width: 4px;
            height: 20px;
            background: var(--primary-blue);
            margin: 0 2px;
            border-radius: 2px;
            animation: visualize 0.6s ease-in-out infinite;
        }

        @keyframes visualize {
            0%, 100% { height: 20px; }
            50% { height: 50px; }
        }

        /* ===== RESULTS DISPLAY ===== */
        .results-container {
            padding: 20px;
        }

        .result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .result-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .result-icon {
            font-size: 24px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .result-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .action-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary-blue);
        }

        .action-item-task {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .action-item-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 14px;
            color: var(--text-muted);
        }

        .priority-high {
            border-left-color: var(--accent-red);
        }

        .priority-medium {
            border-left-color: var(--warning-yellow);
        }

        .priority-low {
            border-left-color: var(--accent-green);
        }

        /* ===== HISTORY/LIST VIEW ===== */
        .history-list {
            padding: 20px;
        }

        .history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover, .history-item:active {
            background: var(--bg-card);
            border-color: var(--primary-blue);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-date {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .history-item-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .history-item-summary {
            font-size: 14px;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* ===== LOADING STATES ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-card);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* ===== ALERT/TOAST MESSAGES ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: var(--bg-secondary);
            padding: 16px 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 2000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast.active {
            display: block;
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--error);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-yellow);
        }

        /* ===== SETTINGS SCREEN ===== */
        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .settings-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .api-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .api-status-valid {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .api-status-invalid {
            background: rgba(220, 38, 38, 0.2);
            color: var(--error);
        }

        /* ===== EMPTY STATES ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto;
        }

        /* ===== UTILITY CLASSES ===== */
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .text-center { text-align: center; }
        .hidden { display: none !important; }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (min-width: 768px) {
            .container {
                max-width: 768px;
            }
            .feature-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Processing your meeting...</div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="toast">
        <div id="toastMessage"></div>
    </div>

    <!-- Welcome/Auth Screen -->
    <div class="screen active" id="welcomeScreen">
        <div class="welcome-content">
            <div class="app-logo">üéôÔ∏è</div>
            <h1 class="welcome-title">VoiceGrid</h1>
            <p class="welcome-subtitle">Transform meeting conversations into organized action items with AI-powered analysis</p>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <h3 class="feature-title">Instant Analysis</h3>
                    <p class="feature-description">Record meetings and get structured summaries in seconds using Gemini 3's advanced reasoning</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <h3 class="feature-title">Smart Action Items</h3>
                    <p class="feature-description">Automatically extract tasks with assigned owners and deadlines from conversation context</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîí</div>
                    <h3 class="feature-title">Private & Secure</h3>
                    <p class="feature-description">All data stays on your device with end-to-end encryption for sensitive discussions</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üì±</div>
                    <h3 class="feature-title">Mobile-First</h3>
                    <p class="feature-description">Designed for field workers who need reliable documentation anywhere</p>
                </div>
            </div>

            <button class="btn btn-primary" id="createAccountBtn">Create Account</button>
            <button class="btn btn-secondary" id="guestModeBtn">Continue as Guest</button>
            <button class="btn btn-secondary" id="loginBtn">Sign In</button>
        </div>
    </div>

    <!-- Sign Up Screen -->
    <div class="screen" id="signupScreen">
        <div class="header">
            <button class="icon-btn" id="backToWelcomeFromSignup">‚Üê</button>
            <h2 class="header-title">Create Account</h2>
            <div></div>
        </div>
        <div style="padding: 20px;">
            <form id="signupForm">
                <div class="form-group">
                    <label class="form-label" for="signupEmail">Email Address</label>
                    <input type="email" class="form-input" id="signupEmail" required placeholder="your@email.com">
                    <div class="form-error" id="signupEmailError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPassword">Password</label>
                    <input type="password" class="form-input" id="signupPassword" required placeholder="Create a strong password">
                    <p class="form-hint">Minimum 12 characters with uppercase, lowercase, number, and special character</p>
                    <div class="form-error" id="signupPasswordError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPasswordConfirm">Confirm Password</label>
                    <input type="password" class="form-input" id="signupPasswordConfirm" required placeholder="Re-enter password">
                    <div class="form-error" id="signupPasswordConfirmError"></div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="screen" id="loginScreen">
        <div class="header">
            <button class="icon-btn" id="backToWelcomeFromLogin">‚Üê</button>
            <h2 class="header-title">Sign In</h2>
            <div></div>
        </div>
        <div style="padding: 20px;">
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required placeholder="Enter your password">
                    <div class="form-error" id="loginError"></div>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main App Screen (Recording) -->
    <div class="screen" id="mainScreen">
        <div class="header">
            <h2 class="header-title">VoiceGrid</h2>
            <div class="header-actions">
                <button class="icon-btn" id="historyBtn" title="Meeting History">üìã</button>
                <button class="icon-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="recording-container">
            <button class="record-button" id="recordButton">
                <span id="recordIcon">üéôÔ∏è</span>
            </button>
            <div class="audio-visualizer" id="audioVisualizer">
                <span class="visualizer-bar"></span>
                <span class="visualizer-bar"></span>
                <span class="visualizer-bar"></span>
                <span class="visualizer-bar"></span>
                <span class="visualizer-bar"></span>
            </div>
            <div class="record-status">
                <div class="record-status-text" id="recordStatusText">Tap to start recording</div>
                <div class="record-timer" id="recordTimer">00:00</div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div class="screen" id="resultsScreen">
        <div class="header">
            <button class="icon-btn" id="backToMain">‚Üê</button>
            <h2 class="header-title">Meeting Analysis</h2>
            <button class="icon-btn" id="exportBtn" title="Export">‚¨ÜÔ∏è</button>
        </div>
        <div class="results-container" id="resultsContainer">
            <!-- Results will be dynamically inserted here -->
        </div>
    </div>

    <!-- History Screen -->
    <div class="screen" id="historyScreen">
        <div class="header">
            <button class="icon-btn" id="backToMainFromHistory">‚Üê</button>
            <h2 class="header-title">Meeting History</h2>
            <div></div>
        </div>
        <div class="history-list" id="historyList">
            <!-- History items will be dynamically inserted here -->
        </div>
    </div>

    <!-- Settings Screen -->
    <div class="screen" id="settingsScreen">
        <div class="header">
            <button class="icon-btn" id="backToMainFromSettings">‚Üê</button>
            <h2 class="header-title">Settings</h2>
            <div></div>
        </div>
        <div style="padding: 20px;">
            <div class="settings-section">
                <h3 class="settings-section-title">Gemini API Configuration</h3>
                <div class="settings-card">
                    <div class="form-group">
                        <label class="form-label" for="apiKeyInput">API Key</label>
                        <input type="password" class="form-input" id="apiKeyInput" placeholder="Enter your Gemini API key">
                        <p class="form-hint">Get your free API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary-blue);">Google AI Studio</a></p>
                        <div class="api-status api-status-invalid" id="apiStatus">Not configured</div>
                    </div>
                    <button class="btn btn-primary mt-2" id="saveApiKeyBtn">Save API Key</button>
                    <button class="btn btn-secondary mt-1" id="testApiKeyBtn">Test Connection</button>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section-title">Account</h3>
                <div class="settings-card">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        <strong>Logged in as:</strong> <span id="currentUserEmail">Guest Mode</span>
                    </p>
                    <button class="btn btn-danger" id="signOutBtn">Sign Out</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== VOICEGRID APPLICATION - JAVASCRIPT =====
        
        // Application state management
        const AppState = {
            currentScreen: 'welcome',
            isRecording: false,
            recordingStartTime: null,
            recordingTimer: null,
            mediaRecorder: null,
            audioChunks: [],
            currentUser: null,
            apiKey: null,
            meetings: [],
            currentMeetingId: null
        };

        // ===== ENCRYPTION AND SECURITY =====
        
        /**
         * Password hashing using Web Crypto API with PBKDF2
         * Implements industry-standard password security
         */
        async function hashPassword(password, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hashBuffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        /**
         * Generate cryptographically secure random salt
         */
        function generateSalt() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return Array.from(array).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        /**
         * Simple encryption for sensitive data storage
         * In production, would use more robust encryption like AES-GCM
         */
        function encryptData(data, key) {
            // For demo purposes using base64 encoding
            // In production deployment, implement proper AES-GCM encryption
            return btoa(JSON.stringify(data));
        }

        function decryptData(encryptedData, key) {
            try {
                return JSON.parse(atob(encryptedData));
            } catch {
                return null;
            }
        }

        // ===== STORAGE MANAGEMENT =====
        
        /**
         * Save data to IndexedDB with encryption
         * All sensitive data is encrypted before storage
         */
        async function saveToStorage(key, value) {
            try {
                const encrypted = encryptData(value, 'voicegrid-key');
                localStorage.setItem(key, encrypted);
                return true;
            } catch (error) {
                console.error('Storage error:', error);
                return false;
            }
        }

        async function getFromStorage(key) {
            try {
                const encrypted = localStorage.getItem(key);
                if (!encrypted) return null;
                return decryptData(encrypted, 'voicegrid-key');
            } catch (error) {
                console.error('Retrieval error:', error);
                return null;
            }
        }

        // ===== AUTHENTICATION SYSTEM =====
        
        /**
         * Validate password meets security requirements
         */
        function validatePassword(password) {
            if (password.length < 12) {
                return 'Password must be at least 12 characters';
            }
            if (!/[A-Z]/.test(password)) {
                return 'Password must contain uppercase letter';
            }
            if (!/[a-z]/.test(password)) {
                return 'Password must contain lowercase letter';
            }
            if (!/[0-9]/.test(password)) {
                return 'Password must contain number';
            }
            if (!/[^A-Za-z0-9]/.test(password)) {
                return 'Password must contain special character';
            }
            return null;
        }

        /**
         * Create new user account
         */
        async function createAccount(email, password) {
            const passwordError = validatePassword(password);
            if (passwordError) {
                throw new Error(passwordError);
            }

            const users = await getFromStorage('users') || {};
            
            if (users[email]) {
                throw new Error('Account already exists');
            }

            const salt = generateSalt();
            const passwordHash = await hashPassword(password, salt);
            
            users[email] = {
                email,
                passwordHash,
                salt,
                createdAt: new Date().toISOString()
            };

            await saveToStorage('users', users);
            return users[email];
        }

        /**
         * Authenticate user login
         */
        async function loginUser(email, password) {
            const users = await getFromStorage('users') || {};
            const user = users[email];
            
            if (!user) {
                throw new Error('Invalid credentials');
            }

            const passwordHash = await hashPassword(password, user.salt);
            
            if (passwordHash !== user.passwordHash) {
                throw new Error('Invalid credentials');
            }

            return user;
        }

        /**
         * Set current user session
         */
        async function setCurrentUser(user) {
            AppState.currentUser = user;
            await saveToStorage('currentUser', user);
            
            // Load user's meetings
            if (user && user.email) {
                AppState.meetings = await getFromStorage(`meetings_${user.email}`) || [];
            }
        }

        // ===== GEMINI API INTEGRATION =====
        
        /**
         * Validate API key by testing a simple call
         */
        async function validateApiKey(apiKey) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: 'Hello' }]
                        }]
                    })
                });

                return response.ok;
            } catch {
                return false;
            }
        }

        /**
         * Process meeting audio with Gemini 3
         * Uses advanced prompting for structured meeting analysis
         */
        async function analyzeMeeting(audioBlob) {
            if (!AppState.apiKey) {
                throw new Error('API key not configured. Please add your Gemini API key in Settings.');
            }

            showLoading('Analyzing your meeting with Gemini...');

            try {
                // Convert audio blob to base64
                const base64Audio = await blobToBase64(audioBlob);
                
                // Construct comprehensive system prompt for Gemini
                const systemPrompt = `You are an expert meeting analyst. Analyze this business conversation audio and extract structured information.

Your analysis must include:
1. A concise summary of what was discussed
2. Main discussion topics as an array
3. Key decisions made with rationale
4. Action items with inferred owners and deadlines

For action items, infer ownership from conversational context even when not explicitly stated. Convert relative deadlines like "by end of week" to specific dates. Assign priority (high/medium/low) based on urgency cues in the conversation.

Return ONLY valid JSON matching this exact schema:
{
  "summary": "string - 2-3 sentence overview",
  "topics": ["string array of main discussion areas"],
  "decisions": [{"decision": "string", "rationale": "string"}],
  "actionItems": [{
    "task": "string",
    "owner": "string or 'Unassigned'",
    "deadline": "string or 'Not specified'",
    "priority": "high|medium|low",
    "confidence": 0.0-1.0
  }]
}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${AppState.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                {
                                    inline_data: {
                                        mime_type: audioBlob.type,
                                        data: base64Audio
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 2048
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Analysis failed');
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // Extract JSON from response (handle markdown code blocks)
                let jsonText = text.trim();
                if (jsonText.includes('```json')) {
                    jsonText = jsonText.split('```json')[1].split('```')[0].trim();
                } else if (jsonText.includes('```')) {
                    jsonText = jsonText.split('```')[1].split('```')[0].trim();
                }

                const analysis = JSON.parse(jsonText);
                
                hideLoading();
                return analysis;

            } catch (error) {
                hideLoading();
                throw error;
            }
        }

        /**
         * Convert blob to base64 string
         */
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // ===== RECORDING MANAGEMENT =====
        
        /**
         * Start audio recording
         */
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });

                AppState.mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm'
                });

                AppState.audioChunks = [];

                AppState.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        AppState.audioChunks.push(event.data);
                    }
                };

                AppState.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(AppState.audioChunks, { type: 'audio/webm' });
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Process the recording
                    await processRecording(audioBlob);
                };

                AppState.mediaRecorder.start();
                AppState.isRecording = true;
                AppState.recordingStartTime = Date.now();
                
                // Update UI
                updateRecordingUI();
                startRecordingTimer();
                
                showToast('Recording started', 'success');

            } catch (error) {
                console.error('Recording error:', error);
                showToast('Microphone access denied. Please enable microphone in browser settings.', 'error');
            }
        }

        /**
         * Stop audio recording
         */
        function stopRecording() {
            if (AppState.mediaRecorder && AppState.isRecording) {
                AppState.mediaRecorder.stop();
                AppState.isRecording = false;
                stopRecordingTimer();
                updateRecordingUI();
            }
        }

        /**
         * Process recorded audio
         */
        async function processRecording(audioBlob) {
            try {
                const analysis = await analyzeMeeting(audioBlob);
                
                // Save meeting to history
                const meeting = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    duration: Math.floor((Date.now() - AppState.recordingStartTime) / 1000),
                    analysis,
                    audioBlob: null // Don't store audio in production to save space
                };

                AppState.meetings.unshift(meeting);
                AppState.currentMeetingId = meeting.id;

                // Save to storage
                if (AppState.currentUser) {
                    await saveToStorage(`meetings_${AppState.currentUser.email}`, AppState.meetings);
                }

                // Display results
                displayMeetingResults(analysis);
                showScreen('resultsScreen');
                
            } catch (error) {
                console.error('Processing error:', error);
                showToast(error.message, 'error');
            }
        }

        /**
         * Display meeting analysis results
         */
        function displayMeetingResults(analysis) {
            const container = document.getElementById('resultsContainer');
            
            let html = '';

            // Summary
            html += `
                <div class="result-card">
                    <div class="result-card-header">
                        <span class="result-icon">üìù</span>
                        <h3 class="result-title">Meeting Summary</h3>
                    </div>
                    <div class="result-content">${analysis.summary || 'No summary available'}</div>
                </div>
            `;

            // Topics
            if (analysis.topics && analysis.topics.length > 0) {
                html += `
                    <div class="result-card">
                        <div class="result-card-header">
                            <span class="result-icon">üí¨</span>
                            <h3 class="result-title">Discussion Topics</h3>
                        </div>
                        <div class="result-content">
                            ${analysis.topics.map(topic => `<div style="margin-bottom: 8px;">‚Ä¢ ${topic}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Decisions
            if (analysis.decisions && analysis.decisions.length > 0) {
                html += `
                    <div class="result-card">
                        <div class="result-card-header">
                            <span class="result-icon">‚úÖ</span>
                            <h3 class="result-title">Key Decisions</h3>
                        </div>
                        <div class="result-content">
                            ${analysis.decisions.map(d => `
                                <div style="margin-bottom: 12px;">
                                    <strong>${d.decision}</strong>
                                    ${d.rationale ? `<div style="color: var(--text-muted); font-size: 14px; margin-top: 4px;">${d.rationale}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Action Items
            if (analysis.actionItems && analysis.actionItems.length > 0) {
                html += `
                    <div class="result-card">
                        <div class="result-card-header">
                            <span class="result-icon">üéØ</span>
                            <h3 class="result-title">Action Items</h3>
                        </div>
                        <div class="result-content">
                            ${analysis.actionItems.map(item => `
                                <div class="action-item priority-${item.priority || 'medium'}">
                                    <div class="action-item-task">${item.task}</div>
                                    <div class="action-item-meta">
                                        <span>üë§ ${item.owner || 'Unassigned'}</span>
                                        <span>üìÖ ${item.deadline || 'Not specified'}</span>
                                        <span>‚ö° ${(item.priority || 'medium').toUpperCase()}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // ===== UI UPDATE FUNCTIONS =====
        
        function updateRecordingUI() {
            const recordButton = document.getElementById('recordButton');
            const recordIcon = document.getElementById('recordIcon');
            const statusText = document.getElementById('recordStatusText');
            const visualizer = document.getElementById('audioVisualizer');
            const timer = document.getElementById('recordTimer');

            if (AppState.isRecording) {
                recordButton.classList.add('recording');
                recordIcon.textContent = '‚èπÔ∏è';
                statusText.textContent = 'Recording in progress...';
                visualizer.classList.add('active');
                timer.classList.add('recording');
            } else {
                recordButton.classList.remove('recording');
                recordIcon.textContent = 'üéôÔ∏è';
                statusText.textContent = 'Tap to start recording';
                visualizer.classList.remove('active');
                timer.classList.remove('recording');
                timer.textContent = '00:00';
            }
        }

        function startRecordingTimer() {
            AppState.recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - AppState.recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('recordTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function stopRecordingTimer() {
            if (AppState.recordingTimer) {
                clearInterval(AppState.recordingTimer);
                AppState.recordingTimer = null;
            }
        }

        // ===== SCREEN NAVIGATION =====
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            AppState.currentScreen = screenId;
        }

        // ===== LOADING AND TOAST =====
        
        function showLoading(message = 'Processing...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast toast-${type} active`;
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 4000);
        }

        // ===== HISTORY DISPLAY =====
        
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            
            if (!AppState.meetings || AppState.meetings.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3 class="empty-state-title">No Meetings Yet</h3>
                        <p class="empty-state-text">Record your first meeting to see it appear here</p>
                    </div>
                `;
                return;
            }

            const html = AppState.meetings.map(meeting => {
                const date = new Date(meeting.timestamp);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="history-item" data-meeting-id="${meeting.id}">
                        <div class="history-item-header">
                            <span class="history-item-date">${dateStr}</span>
                            <span class="history-item-time">${timeStr}</span>
                        </div>
                        <div class="history-item-summary">${meeting.analysis.summary || 'Meeting recording'}</div>
                    </div>
                `;
            }).join('');

            historyList.innerHTML = html;

            // Add click handlers
            document.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const meetingId = item.dataset.meetingId;
                    const meeting = AppState.meetings.find(m => m.id === meetingId);
                    if (meeting) {
                        AppState.currentMeetingId = meetingId;
                        displayMeetingResults(meeting.analysis);
                        showScreen('resultsScreen');
                    }
                });
            });
        }

        // ===== INITIALIZATION =====
        
        async function initApp() {
            // Load saved state
            AppState.currentUser = await getFromStorage('currentUser');
            AppState.apiKey = await getFromStorage('apiKey');

            if (AppState.currentUser) {
                AppState.meetings = await getFromStorage(`meetings_${AppState.currentUser.email}`) || [];
                document.getElementById('currentUserEmail').textContent = AppState.currentUser.email;
            }

            // Update API status
            if (AppState.apiKey) {
                document.getElementById('apiKeyInput').value = AppState.apiKey;
                document.getElementById('apiStatus').textContent = 'Configured';
                document.getElementById('apiStatus').classList.remove('api-status-invalid');
                document.getElementById('apiStatus').classList.add('api-status-valid');
            }

            // Event Listeners
            
            // Welcome screen
            document.getElementById('createAccountBtn').addEventListener('click', () => showScreen('signupScreen'));
            document.getElementById('loginBtn').addEventListener('click', () => showScreen('loginScreen'));
            document.getElementById('guestModeBtn').addEventListener('click', () => {
                setCurrentUser(null);
                showScreen('mainScreen');
            });

            // Navigation
            document.getElementById('backToWelcomeFromSignup').addEventListener('click', () => showScreen('welcomeScreen'));
            document.getElementById('backToWelcomeFromLogin').addEventListener('click', () => showScreen('welcomeScreen'));
            document.getElementById('backToMain').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('backToMainFromHistory').addEventListener('click', () => showScreen('mainScreen'));
            document.getElementById('backToMainFromSettings').addEventListener('click', () => showScreen('mainScreen'));
            
            // Main screen
            document.getElementById('recordButton').addEventListener('click', () => {
                if (AppState.isRecording) {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
            
            document.getElementById('historyBtn').addEventListener('click', () => {
                displayHistory();
                showScreen('historyScreen');
            });
            
            document.getElementById('settingsBtn').addEventListener('click', () => showScreen('settingsScreen'));

            // Signup form
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;
                const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

                // Clear previous errors
                document.querySelectorAll('.form-error').forEach(el => el.classList.remove('active'));

                if (password !== passwordConfirm) {
                    document.getElementById('signupPasswordConfirmError').textContent = 'Passwords do not match';
                    document.getElementById('signupPasswordConfirmError').classList.add('active');
                    return;
                }

                try {
                    const user = await createAccount(email, password);
                    await setCurrentUser(user);
                    showToast('Account created successfully!', 'success');
                    showScreen('mainScreen');
                } catch (error) {
                    showToast(error.message, 'error');
                }
            });

            // Login form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;

                try {
                    const user = await loginUser(email, password);
                    await setCurrentUser(user);
                    showToast('Welcome back!', 'success');
                    showScreen('mainScreen');
                } catch (error) {
                    document.getElementById('loginError').textContent = error.message;
                    document.getElementById('loginError').classList.add('active');
                }
            });

            // Settings - API Key
            document.getElementById('saveApiKeyBtn').addEventListener('click', async () => {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                if (apiKey) {
                    AppState.apiKey = apiKey;
                    await saveToStorage('apiKey', apiKey);
                    document.getElementById('apiStatus').textContent = 'Configured';
                    document.getElementById('apiStatus').classList.remove('api-status-invalid');
                    document.getElementById('apiStatus').classList.add('api-status-valid');
                    showToast('API key saved', 'success');
                }
            });

            document.getElementById('testApiKeyBtn').addEventListener('click', async () => {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                if (!apiKey) {
                    showToast('Please enter an API key', 'error');
                    return;
                }

                showLoading('Testing API connection...');
                const isValid = await validateApiKey(apiKey);
                hideLoading();

                if (isValid) {
                    showToast('API key is valid!', 'success');
                    document.getElementById('apiStatus').textContent = 'Valid';
                    document.getElementById('apiStatus').classList.remove('api-status-invalid');
                    document.getElementById('apiStatus').classList.add('api-status-valid');
                } else {
                    showToast('Invalid API key', 'error');
                }
            });

            document.getElementById('signOutBtn').addEventListener('click', async () => {
                await setCurrentUser(null);
                AppState.meetings = [];
                showToast('Signed out', 'success');
                showScreen('welcomeScreen');
            });

            // Export functionality
            document.getElementById('exportBtn').addEventListener('click', () => {
                if (AppState.currentMeetingId) {
                    const meeting = AppState.meetings.find(m => m.id === AppState.currentMeetingId);
                    if (meeting) {
                        const text = formatMeetingAsText(meeting.analysis);
                        downloadAsFile(text, `meeting-${new Date().toISOString().split('T')[0]}.txt`);
                        showToast('Meeting exported', 'success');
                    }
                }
            });
        }

        function formatMeetingAsText(analysis) {
            let text = 'MEETING ANALYSIS\n';
            text += '================\n\n';
            
            text += 'SUMMARY:\n';
            text += analysis.summary + '\n\n';
            
            if (analysis.topics && analysis.topics.length > 0) {
                text += 'TOPICS:\n';
                analysis.topics.forEach(topic => {
                    text += `- ${topic}\n`;
                });
                text += '\n';
            }
            
            if (analysis.decisions && analysis.decisions.length > 0) {
                text += 'DECISIONS:\n';
                analysis.decisions.forEach(d => {
                    text += `- ${d.decision}\n`;
                    if (d.rationale) text += `  Rationale: ${d.rationale}\n`;
                });
                text += '\n';
            }
            
            if (analysis.actionItems && analysis.actionItems.length > 0) {
                text += 'ACTION ITEMS:\n';
                analysis.actionItems.forEach(item => {
                    text += `- ${item.task}\n`;
                    text += `  Owner: ${item.owner || 'Unassigned'}\n`;
                    text += `  Deadline: ${item.deadline || 'Not specified'}\n`;
                    text += `  Priority: ${(item.priority || 'medium').toUpperCase()}\n\n`;
                });
            }
            
            return text;
        }

        function downloadAsFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>